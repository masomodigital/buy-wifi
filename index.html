<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buy WiFi Packages</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; text-align:center; }
  h2 { color: green; margin-bottom:5px; }
  .packages { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-top:20px; }
  .package-card { width:160px; height:160px; border-radius:50%; display:flex; flex-direction:column; justify-content:center; align-items:center; color:#fff; font-weight:bold; cursor:pointer; padding:15px; box-shadow:0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s; }
  .package-card:hover { transform: scale(1.05); }
  .package-name { font-size:16px; margin-bottom:5px; }
  .package-duration, .package-price { font-size:14px; }
  .buy-btn { background:#fff; border:1px solid #000; color:#000; padding:6px 12px; border-radius:12px; cursor:pointer; font-weight:bold; }
  .buy-btn:hover { background:#f0f0f0; }

  .color1 { background: #ff6b6b; }
  .color2 { background: #4ecdc4; }
  .color3 { background: #1a535c; }
  .color4 { background: #ff9f1c; }
  .color5 { background: #5c6bc0; }

  /* Modal */
  .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  .modal-content { background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; text-align:center; }
  .modal-message { font-weight:bold; color:green; margin-bottom:15px; }
  .modal-input { width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px; }
  .modal-actions { display:flex; justify-content:center; gap:10px; }
  .modal-btn { background:#007bff; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .modal-btn:hover { background:#0056b3; }
  .cancel-btn { background:#000; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .cancel-btn:hover { background:#333; }

  @media (max-width:600px) {
    .package-card { width:180px; height:180px; font-size:18px; }
    .package-name { font-size:18px; }
    .package-duration, .package-price { font-size:16px; }
  }
</style>
</head>
<body>

<div class="header">
  <h2 id="hotspotName">Loading WiFi...</h2>
  <p>Provided by <b id="sellerName"></b></p>
  <p class="support">For support contact: <b id="sellerMpesa"></b></p>
</div>

<div class="packages" id="packagesContainer"></div>

<!-- Modal -->
<div class="modal" id="phoneModal">
  <div class="modal-content">
    <div class="modal-message">Kindly input Mpesa number to make payment.</div>
    <input type="text" id="phoneInput" class="modal-input" placeholder="07xxxxxxxx">
    <div class="modal-actions">
      <button class="modal-btn" onclick="submitPhone()">Proceed</button>
      <button class="cancel-btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyzVG18wFaaNQPwP1iTc7zPSGqxJ3u-ATQXnFOY7M6llzxPo4GmODNNf02e9jn7Y6bn/exec";

let sellerId = "", routerId = "", subaccountID = "", selectedPackage = {};

// Get router ID from URL
const params = new URLSearchParams(window.location.search);
routerId = params.get("router");

if (!routerId) {
  alert("Router ID missing in URL");
} else {
  fetch(`${GAS_URL}?router=${routerId}`)
    .then(res => res.json())
    .then(data => {
      if (data.status !== "ok") { alert(data.message); return; }
      document.getElementById("hotspotName").textContent = data.hotspotName;
      document.getElementById("sellerName").textContent = data.sellerName;
      document.getElementById("sellerMpesa").textContent = data.sellerMpesa;

      sellerId = data.sellerId;
      subaccountID = data.subaccountID;

      // Render packages dynamically
      const container = document.getElementById("packagesContainer");
      const colors = ["color1","color2","color3","color4","color5"];
      data.packages.forEach((pkg, i) => {
        const card = document.createElement("div");
        card.className = `package-card ${colors[i % colors.length]}`;
        card.innerHTML = `
          <div class="package-name">${pkg.name}</div>
          <div class="package-duration">${pkg.duration} hrs</div>
          <div class="package-price">KES ${pkg.price}</div>
          <button class="buy-btn" onclick="openModal('${pkg.id}','${pkg.price}','${pkg.duration}')">Buy Now</button>
        `;
        container.appendChild(card);
      });
    })
    .catch(err => console.error("Error fetching router data:", err));
}

function openModal(packageId, price, duration) {
  selectedPackage = { packageId, price, duration };
  document.getElementById("phoneModal").style.display = "flex";
  document.getElementById("phoneInput").value = "07";
}

function closeModal() {
  document.getElementById("phoneModal").style.display = "none";
}

function normalizePhone(number) {
  number = number.trim();
  if (number.startsWith("0") && number.length === 10) return "+254" + number.slice(1);
  if (number.startsWith("+254") && number.length === 13) return number;
  if (number.length === 9 && number.startsWith("7")) return "+254" + number;
  return number;
}

function submitPhone() {
  let phone = document.getElementById("phoneInput").value;
  if (!phone || !phone.startsWith("07")) { alert("Enter a valid phone number"); return; }
  phone = normalizePhone(phone);
  closeModal();

  const payload = {
    sellerId,
    routerId,
    packageId: selectedPackage.packageId,
    amount: selectedPackage.price,
    durationHrs: selectedPackage.duration,
    phoneNumber: phone
  };

  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(res => {
    if(res.status === "initiated"){
      const msg = res.paystackResponse && res.paystackResponse.status === false 
                  ? res.paystackResponse.message || "Unknown error from Paystack."
                  : `STK Push sent to your phone. Reference: ${res.ref}`;
      alert(msg);
    } else {
      const msg = res.paystackResponse && res.paystackResponse.message 
                  ? res.paystackResponse.message : "Unknown error";
      alert("Payment initiation failed: " + msg);
    }
  })
  .catch(err => {
    console.error(err);
    alert("Payment request failed. Check console for details.");
  });
}
</script>
</body>
</html>
