<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WiFi Packages</title>
<style>
body { font-family: Arial; margin:0; padding:0; text-align:center; background:#f9f9f9; }
h2 { color:green; }
.packages { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-top:20px; }
.package-card { width:160px; height:160px; border-radius:50%; display:flex; flex-direction:column; justify-content:center; align-items:center; color:#fff; cursor:pointer; transition:0.2s; }
.package-card:hover { transform:scale(1.05); }
.color1 { background:#ff6b6b; } .color2 { background:#4ecdc4; } .color3 { background:#1a535c; } .color4 { background:#ff9f1c; } .color5 { background:#5c6bc0; }
.buy-btn { background:#fff; border:1px solid #000; color:#000; padding:6px 12px; border-radius:12px; cursor:pointer; font-weight:bold; }
.buy-btn:hover { background:#f0f0f0; }
.modal { display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; text-align:center; }
.modal-input { width:100%; padding:10px; margin-bottom:15px; font-size:16px; border-radius:8px; border:1px solid #ccc; }
.modal-btn { background:#007bff; color:#fff; padding:8px 14px; border-radius:6px; cursor:pointer; }
.cancel-btn { background:#000; color:#fff; padding:8px 14px; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>

<h2 id="hotspotName">Welcome to HIGH SPEED WiFi</h2>
<p>Provided by <b id="sellerName"></b></p>
<p>For support contact: <b id="sellerMpesa"></b></p>

<div class="packages" id="packagesContainer"></div>

<div class="modal" id="phoneModal">
  <div class="modal-content">
    <div>Enter your Mpesa number</div>
    <input type="text" id="phoneInput" class="modal-input" placeholder="07xxxxxxxx">
    <div style="margin-top:10px;">
      <button class="modal-btn" onclick="submitPhone()">Proceed</button>
      <button class="cancel-btn" onclick="document.getElementById('phoneModal').style.display='none'">Cancel</button>
    </div>
  </div>
</div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbyzVG18wFaaNQPwP1iTc7zPSGqxJ3u-ATQXnFOY7M6llzxPo4GmODNNf02e9jn7Y6bn/exec";
const urlParams = new URLSearchParams(window.location.search);
const routerId = urlParams.get('router');
let sellerId="", selectedPackage={};

function normalizePhone(number){
  number=number.trim();
  if(number.startsWith("0")&&number.length===10) return "+254"+number.slice(1);
  if(number.startsWith("+254")&&number.length===13) return number;
  if(number.length===9&&number.startsWith("7")) return "+254"+number;
  return number;
}

function openModal(pkg){
  selectedPackage = pkg;
  document.getElementById("phoneModal").style.display="flex";
  document.getElementById("phoneInput").value="07";
}

function submitPhone(){
  let phone = document.getElementById("phoneInput").value;
  if(!phone.startsWith("07")) { alert("Enter valid number"); return; }
  phone = normalizePhone(phone);
  document.getElementById("phoneModal").style.display="none";

  fetch(webAppUrl,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      routerId,
      sellerId,
      packageId:selectedPackage.id,
      amount:selectedPackage.price,
      durationHrs:selectedPackage.duration,
      phoneNumber:phone
    })
  })
  .then(res=>res.json())
  .then(res=>{
    if(res.status==="initiated") alert("STK Push sent! Ref: "+res.ref);
    else alert("Payment error: "+(res.message||JSON.stringify(res)));
  })
  .catch(err=>alert("Network error: "+err));
}

function loadData(){
  if(!routerId) { alert("Router missing in URL"); return; }
  fetch(`${webAppUrl}?router=${routerId}`)
    .then(res=>res.json())
    .then(data=>{
      if(data.status!=="ok"){ alert(data.message); return; }
      document.getElementById("hotspotName").innerText=data.hotspotName;
      document.getElementById("sellerName").innerText=data.sellerName;
      document.getElementById("sellerMpesa").innerText=data.sellerMpesa;
      sellerId = data.sellerId;

      const colors=["color1","color2","color3","color4","color5"];
      const container=document.getElementById("packagesContainer");
      data.packages.forEach((p,i)=>{
        const div=document.createElement("div");
        div.className="package-card "+colors[i%colors.length];
        div.innerHTML=`<div>${p.name}</div><div>KSh ${p.price}</div><div>${p.duration}hrs</div><button class="buy-btn" onclick='openModal(${JSON.stringify(p)})'>Buy</button>`;
        container.appendChild(div);
      });
    }).catch(err=>alert("Failed to load: "+err));
}

window.onload=loadData;
</script>

</body>
</html>

