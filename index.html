<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WiFi Packages</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }
    h2 { color: green; font-weight: bold; margin-bottom: 5px; }
    .header { margin-bottom: 20px; }
    .support { margin-top: 10px; font-size: 14px; color: #555; }
    .support b { color: #000; }
    .packages { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 900px; }
    .package-card {
      width: 160px; height: 160px; border-radius: 50%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: #fff; font-weight: bold; padding: 15px; cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s; flex-shrink: 0;
    }
    .package-card:hover { transform: scale(1.05); }
    .package-name { font-size: 16px; margin-bottom: 5px; }
    .package-duration, .package-price { font-size: 14px; margin: 5px 0; }
    .buy-btn { background: #fff; border: 1px solid #000; color: #000; padding: 6px 12px; border-radius: 12px; cursor: pointer; font-weight: bold; }
    .buy-btn:hover { background: #f0f0f0; }
    .color1 { background: #ff6b6b; } .color2 { background: #4ecdc4; } .color3 { background: #1a535c; } 
    .color4 { background: #ff9f1c; } .color5 { background: #5c6bc0; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 12px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .modal-message { font-weight: bold; color: green; margin-bottom: 15px; }
    .modal-input { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; }
    .modal-actions { display: flex; justify-content: center; gap: 10px; }
    .modal-btn { background: #007bff; color: #fff; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; }
    .modal-btn:hover { background: #0056b3; }
    .cancel-btn { background: #000; color: #fff; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; }
    .cancel-btn:hover { background: #333; }
    @media (max-width: 600px) { .package-card { width: 180px; height: 180px; font-size: 18px; } .package-name { font-size: 18px; } .package-duration, .package-price { font-size: 16px; } }
    @media (max-width: 400px) { .packages { flex-direction: column; align-items: center; } .package-card { width: 200px; height: 200px; } }
  </style>
</head>
<body>

  <div class="header">
    <h2 id="hotspotName">Loading...</h2>
    <p>Provided by <b id="sellerName"></b></p>
    <p class="support">For support contact: <b id="sellerMpesa"></b></p>
  </div>

  <div class="packages" id="packagesContainer"></div>

  <div class="modal" id="phoneModal">
    <div class="modal-content">
      <div class="modal-message">Kindly input Mpesa number to make payment and get connected.</div>
      <input type="text" id="phoneInput" class="modal-input" placeholder="07xxxxxxxx">
      <div class="modal-actions">
        <button class="modal-btn" onclick="submitPhone()">Proceed</button>
        <button class="cancel-btn" onclick="document.getElementById('phoneModal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyzVG18wFaaNQPwP1iTc7zPSGqxJ3u-ATQXnFOY7M6llzxPo4GmODNNf02e9jn7Y6bn/exec?router=R001";
let selectedPackage = {};

function normalizePhone(number){
  number = number.trim();
  if(number.startsWith("0") && number.length===10) return "+254"+number.slice(1);
  if(number.startsWith("+254") && number.length===13) return number;
  if(number.length===9 && number.startsWith("7")) return "+254"+number;
  return number;
}

function openModal(packageId, price, duration){
  selectedPackage = {packageId, price, duration};
  document.getElementById("phoneModal").style.display = "flex";
  document.getElementById("phoneInput").value = "07";
}

function submitPhone(){
  let phone = document.getElementById("phoneInput").value;
  if(!phone || !phone.startsWith("07")){ alert("Enter a valid 07 number"); return; }
  phone = normalizePhone(phone);
  document.getElementById("phoneModal").style.display="none";

  fetch(WEB_APP_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      function: "startMpesaPayment",
      sellerId: window.sellerId,
      routerId: window.routerId,
      packageId: selectedPackage.packageId,
      amount: selectedPackage.price,
      durationHrs: selectedPackage.duration,
      phoneNumber: phone
    })
  }).then(res => res.json()).then(res=>{
    if(res.status==="initiated"){
      alert("STK Push sent. Reference: "+res.ref);
    } else {
      alert("Error initiating payment: "+(res.paystackResponse?.message||"Unknown"));
    }
  }).catch(err=>alert("Server error: "+err));
}

// Load data from Apps Script web app
fetch(WEB_APP_URL)
  .then(res=>res.json())
  .then(data=>{
    window.sellerId = data.sellerId;
    window.routerId = data.routerId;
    document.getElementById("hotspotName").innerText = "Welcome to HIGH SPEED "+data.hotspotName+" WiFi";
    document.getElementById("sellerName").innerText = data.sellerName;
    document.getElementById("sellerMpesa").innerText = "0"+data.sellerMpesa;

    const container = document.getElementById("packagesContainer");
    data.packages.forEach((pkg,i)=>{
      const colorClass = "color"+((i%5)+1);
      const card = document.createElement("div");
      card.className = "package-card "+colorClass;
      card.innerHTML = `
        <div class="package-name">${pkg.name}</div>
        <div class="package-duration">${pkg.duration} hrs</div>
        <div class="package-price">KES ${pkg.price}</div>
        <button class="buy-btn" onclick="openModal('${pkg.id}','${pkg.price}','${pkg.duration}')">Buy Now</button>
      `;
      container.appendChild(card);
    });
  })
  .catch(err=>alert("Failed to load WiFi packages: "+err));
</script>

</body>
</html>
