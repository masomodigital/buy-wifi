<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WiFi Packages</title>
  <style>
    body { font-family: Arial; text-align: center; background: #f9f9f9; }
    h2 { color: green; }
    .packages { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 900px; margin: auto; }
    .package-card { width: 160px; height: 160px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff; font-weight: bold; padding: 15px; cursor: pointer; }
    .buy-btn { background: #fff; border: 1px solid #000; color: #000; padding: 6px 12px; border-radius: 12px; cursor: pointer; margin-top: 5px; }
    .color1 { background: #ff6b6b; }
    .color2 { background: #4ecdc4; }
    .color3 { background: #1a535c; }
    .color4 { background: #ff9f1c; }
    .color5 { background: #5c6bc0; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; }
    .modal-input { width: 100%; padding: 10px; font-size: 16px; margin-bottom: 15px; }
    .modal-btn { background: #007bff; color: #fff; padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; }
    .cancel-btn { background: #000; color: #fff; padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>

<h2 id="hotspotName">Loading...</h2>
<p>Provided by <b id="sellerName"></b></p>
<p>Support: <b id="sellerMpesa"></b></p>

<div class="packages" id="packagesContainer"></div>

<!-- Modal -->
<div class="modal" id="phoneModal">
  <div class="modal-content">
    <div>Enter Mpesa number:</div>
    <input type="text" id="phoneInput" class="modal-input" placeholder="07xxxxxxxx">
    <button class="modal-btn" onclick="submitPhone()">Proceed</button>
    <button class="cancel-btn" onclick="closeModal()">Cancel</button>
  </div>
</div>

<script>
const webAppUrl = "https://script.google.com/a/macros/prolificlifemission.life/s/AKfycbyzVG18wFaaNQPwP1iTc7zPSGqxJ3u-ATQXnFOY7M6llzxPo4GmODNNf02e9jn7Y6bn/exec?router=R001";
let packages = [];
let selectedPackage = {};

fetch(webAppUrl)
  .then(res => res.json())
  .then(data => {
    if(data.error){ alert(data.error); return; }
    document.getElementById("hotspotName").innerText = "Welcome to HIGH SPEED " + data.hotspotName + " WiFi";
    document.getElementById("sellerName").innerText = data.sellerName;
    document.getElementById("sellerMpesa").innerText = "0" + data.sellerMpesa;
    packages = data.packages;
    renderPackages();
  })
  .catch(err => alert("Failed to load WiFi packages: " + err));

function renderPackages(){
  const container = document.getElementById("packagesContainer");
  packages.forEach((p,i) => {
    const div = document.createElement("div");
    div.className = "package-card color" + ((i % 5) + 1);
    div.innerHTML = `
      <div>${p.name}</div>
      <div>${p.duration} hrs</div>
      <div>KES ${p.price}</div>
      <button class="buy-btn" onclick="openModal(${i})">Buy Now</button>
    `;
    container.appendChild(div);
  });
}

function openModal(index){
  selectedPackage = packages[index];
  document.getElementById("phoneModal").style.display = "flex";
  document.getElementById("phoneInput").value = "07";
}

function closeModal(){
  document.getElementById("phoneModal").style.display = "none";
}

function normalizePhone(number){
  number = number.trim();
  if(number.startsWith("0") && number.length===10) return "+254" + number.slice(1);
  if(number.startsWith("+254") && number.length===13) return number;
  if(number.length===9 && number.startsWith("7")) return "+254" + number;
  return number;
}

function submitPhone(){
  let phone = document.getElementById("phoneInput").value;
  if(!phone.startsWith("07")){ alert("Enter valid phone number"); return; }
  phone = normalizePhone(phone);
  closeModal();

  fetch(`${webAppUrl}&action=startPayment&packageId=${selectedPackage.id}&price=${selectedPackage.price}&duration=${selectedPackage.duration}&phone=${phone}`)
    .then(r => r.json())
    .then(res => {
      if(res.status === "initiated"){
        alert("STK Push sent. Reference: " + res.ref);
      } else {
        alert("Payment initiation failed: " + (res.paystackResponse?.message || "Unknown error"));
      }
    })
    .catch(err => alert("Payment failed: " + err));
}
</script>

</body>
</html>
